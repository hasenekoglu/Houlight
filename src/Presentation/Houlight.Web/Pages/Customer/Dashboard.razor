@page "/customer/dashboard"
@using Houlight.Domain.Entities
@using Houlight.Domain.Enums
@using Houlight.Web.Services
@using Blazored.LocalStorage
@inject AuthHttpClient Http
@inject ILocalStorageService localStorage
@inject NavigationManager NavigationManager

<PageTitle>Müşteri Paneli - Houlight</PageTitle>

<div class="container py-4">
    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm border-0 dashboard-card">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-4">
                        <div class="flex-shrink-0">
                            <i class="bi bi-person-circle display-4 text-houlight-accent"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h5 class="mb-1 fw-bold">@customer?.Name @customer?.Surname</h5>
                            <p class="text-muted mb-0">
                                <i class="bi bi-envelope me-1"></i>@customer?.Email
                            </p>
                        </div>
                    </div>
                    <div class="list-group list-group-flush dashboard-menu">
                        <a href="/customer/profile" class="list-group-item list-group-item-action d-flex align-items-center">
                            <i class="bi bi-person me-2 text-houlight-accent"></i>
                            <span>Profil Bilgileri</span>
                            <i class="bi bi-chevron-right ms-auto text-muted"></i>
                        </a>
                        <a href="/customer/loads" class="list-group-item list-group-item-action d-flex align-items-center">
                            <i class="bi bi-truck me-2 text-houlight-accent"></i>
                            <span>Yüklerim</span>
                            <i class="bi bi-chevron-right ms-auto text-muted"></i>
                        </a>
                        <a href="/customer/offers" class="list-group-item list-group-item-action d-flex align-items-center">
                            <i class="bi bi-cart me-2 text-houlight-accent"></i>
                            <span>Tekliflerim</span>
                            <i class="bi bi-chevron-right ms-auto text-muted"></i>
                        </a>
                        <button class="list-group-item list-group-item-action text-danger d-flex align-items-center" @onclick="HandleLogout" type="button">
                            <i class="bi bi-box-arrow-right me-2"></i>
                            <span>Çıkış Yap</span>
                            <i class="bi bi-chevron-right ms-auto text-muted"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="row">
                <div class="col-md-6 mb-4">
                    <a href="/customer/loads" class="text-decoration-none">
                        <div class="card shadow-sm border-0 h-100 dashboard-card">
                        <div class="card-body">
                                <h5 class="dashboard-title d-flex align-items-center">
                                    <i class="bi bi-truck me-2 text-houlight-accent"></i>
                                    Aktif Yükler
                                </h5>
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                        <div class="dashboard-stat-icon bg-houlight-accent-light">
                                            <i class="bi bi-truck text-houlight-accent"></i>
                                        </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                        <div class="dashboard-stat-value">@activeLoads</div>
                                        <div class="dashboard-stat-label">Aktif Yük</div>
                                    </div>
                                    <i class="bi bi-arrow-right text-houlight-accent ms-auto"></i>
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
                
                <div class="col-md-6 mb-4">
                    <a href="/customer/offers" class="text-decoration-none">
                        <div class="card shadow-sm border-0 h-100 dashboard-card">
                        <div class="card-body">
                                <h5 class="dashboard-title d-flex align-items-center">
                                    <i class="bi bi-cart me-2 text-houlight-accent"></i>
                                    Bekleyen Teklifler
                                </h5>
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                        <div class="dashboard-stat-icon bg-houlight-accent-light">
                                            <i class="bi bi-cart text-houlight-accent"></i>
                                        </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                        <div class="dashboard-stat-value">@pendingOffers</div>
                                        <div class="dashboard-stat-label">Bekleyen Teklif</div>
                                    </div>
                                    <i class="bi bi-arrow-right text-houlight-accent ms-auto"></i>
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
            
            <div class="card shadow-sm border-0 dashboard-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="dashboard-title d-flex align-items-center">
                            <i class="bi bi-clock-history me-2 text-houlight-accent"></i>
                            Son Yüklerim
                        </h5>
                        <a href="/customer/loads" class="dashboard-back-btn">
                            <i class="bi bi-arrow-right"></i>
                            Tümünü Gör
                        </a>
                    </div>
                    
                    @if (recentLoads.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover dashboard-table">
                                <thead>
                                    <tr>
                                        <th>Yük No</th>
                                        <th>Nereden</th>
                                        <th>Nereye</th>
                                        <th>Durum</th>
                                        <th>Tarih</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var load in recentLoads)
                                    {
                                        <tr>
                                            <td>
                                                <span class="fw-medium">@load.Id.ToString().Substring(0, 8)</span>
                                            </td>
                                            <td>@load.FromLocation</td>
                                            <td>@load.ToLocation</td>
                                            <td>
                                                <span class="badge bg-@GetStatusColor(load.Status)" style="font-size: 0.8rem; padding: 0.35em 0.65em;">
                                                    @GetStatusName(load.Status)
                                                </span>
                                            </td>
                                            <td>@load.DeliveryDate?.ToShortDateString()</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <div class="dashboard-empty-state">
                                <i class="bi bi-truck display-4 text-houlight-accent mb-3"></i>
                            <p class="text-muted mb-0">Henüz yük bulunmuyor.</p>
                                <a href="/customer/loads" class="dashboard-back-btn mt-3">
                                    <i class="bi bi-plus-circle"></i>
                                    Yeni Yük Ekle
                                </a>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private CustomerEntity? customer;
    private int activeLoads = 0;
    private int pendingOffers = 0;
    private List<LoadEntity> recentLoads = new();
    private string errorMessage = "";
    private bool isLoading = false;
    private Guid? currentUserId;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        var userId = await localStorage.GetItemAsync<string>("userId");
        if (Guid.TryParse(userId, out var parsedId))
            currentUserId = parsedId;
        await LoadDashboardData();
        isLoading = false;
    }

    private async Task LoadDashboardData()
    {
        try
        {
            // Müşteri profilini çek
            customer = await Http.GetAsync<CustomerEntity>("api/customers/profile");
            if (customer != null)
            {
                await localStorage.SetItemAsync("userName", $"{customer.Name} {customer.Surname}");
            }

            // Yükleri çek
            var loads = await Http.GetAsync<List<LoadEntity>>("api/loads/filter");
            if (loads != null)
            {
                // Sadece giriş yapan kullanıcıya ait yükler
                if (currentUserId.HasValue)
                    loads = loads.Where(x => x.CustomerId == currentUserId.Value).ToList();

                // Aktif yükleri say (Beklemede, Yolda, Atandı ve Kabul Edildi durumundaki yükler)
                activeLoads = loads.Count(x => 
                    x.Status == LoadStatus.Pending || 
                    x.Status == LoadStatus.InTransit || 
                    x.Status == LoadStatus.Assigned || 
                    x.Status == LoadStatus.Accepted);

                // Son 5 yükü al (oluşturulma tarihine göre sırala)
                recentLoads = loads
                    .OrderByDescending(x => x.CreateDate)
                    .Take(5)
                    .ToList();

                // Bekleyen teklifleri say (Henüz kabul edilmemiş yükler)
                pendingOffers = loads.Count(x => x.Status == LoadStatus.Pending);
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Panel verileri yüklenirken bir hata oluştu.";
            Console.WriteLine($"Dashboard veri yükleme hatası: {ex}");
        }
    }

    private string GetStatusName(LoadStatus status)
    {
        return status switch
        {
            LoadStatus.Pending => "Beklemede",
            LoadStatus.InTransit => "Yolda",
            LoadStatus.Delivered => "Teslim Edildi",
            LoadStatus.Assigned => "Atandı",
            LoadStatus.Accepted => "Kabul Edildi",
            _ => "Bilinmiyor"
        };
    }

    private string GetStatusColor(LoadStatus status)
    {
        return status switch
        {
            LoadStatus.Pending => "warning",
            LoadStatus.InTransit => "primary",
            LoadStatus.Delivered => "success",
            LoadStatus.Assigned => "info",
            LoadStatus.Accepted => "success",
            _ => "secondary"
        };
    }

    private async Task HandleLogout()
    {
        try
    {
        await localStorage.RemoveItemAsync("authToken");
        await localStorage.RemoveItemAsync("userType");
        await localStorage.RemoveItemAsync("userName");
            await localStorage.RemoveItemAsync("userId");
            NavigationManager.NavigateTo("/login", true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Çıkış yapma hatası: {ex}");
            errorMessage = "Çıkış yapılırken bir hata oluştu.";
        }
    }
} 